<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Website</title>
  <link rel="stylesheet" href="/stylesheets/styles.css">
  <link rel="stylesheet" href="/stylesheets/others.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://kit.fontawesome.com/bbe06e3f12.js" crossorigin="anonymous"></script>
  <script src="/App.js" defer></script>
  <script>
    function get_members() {
    let xhttp = new XMLHttpRequest();

    xhttp.onreadystatechange = function () {
      if (this.readyState == 4 && this.status == 200) {
        var responseJSON = JSON.parse(this.responseText);

        console.log(this.responseText);
        console.log(responseJSON);

        var container;

        container = document.getElementById('branch-name');
        container.innerText = responseJSON.branch_name;

        container = document.getElementById('members-container');
        container.innerHTML = "";
        for (let i = 0; i < responseJSON.members.length; i++) {
          // Reset manager information.
          var note_manager = '';
          // Checks if member is manager.
          if (responseJSON.members[i].branch_managed !== null) {
            // Can make more specific using: `(Manages Branch: ${responseJSON.members[i].branch_managed})`;
            note_manager = `(Manager)`;
          }

          container.innerHTML += `
            <div id="member-${responseJSON.members[i].username}" class="view-members-container">
                <p>
                  <b> ${responseJSON.members[i].first_name} ${responseJSON.members[i].last_name} ${note_manager} </b>
                  &emsp;
                  (<u>Email:</u> ${responseJSON.members[i].email})
                  &emsp;
                  (<u>Phone:</u> ${responseJSON.members[i].phone_num})
                  <br>
                  <u>Address:</u> ${responseJSON.members[i].postcode}
                  <br>
                  <button onclick="alert_remove_member('${responseJSON.members[i].first_name} ${responseJSON.members[i].last_name}', '${responseJSON.members[i].username}')" class="right button secondary-button manage-button" type="button"> Remove Member From Branch </button>
                  <button onclick="alert_promote_manager('${responseJSON.members[i].first_name} ${responseJSON.members[i].last_name}', '${responseJSON.members[i].username}')" class="right button primary-button manage-button" type="button"> Promote To Manager </button>
                  <br>
                </p>
            </div>`;
        }
      }
    }

    var branchID = window.location.pathname.split('/')[4];
    xhttp.open("GET", "/manage/get_members?id=" + branchID, true);
    xhttp.send();
  }

  function alert_promote_manager(name, userID) {
    var res = confirm(`Are you sure you want to promote ${name} (${userID}) to a branch manager?`);

    if (res) {
      fetch(`/manage/user/promote/${userID}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(response => {
        if (response.ok) {
          // promoted successfully
          location.reload();
          alert('Member promoted successfully!');
        } else if (response.status === 403) {
          alert('You do not have permission to promote this member.');
        } else {
          alert('Failed to promote member.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while promoting the member');
      });
    }
    else {
      return;
    }
  }

  function alert_remove_member(name, userID) {
    var res = confirm(`Are you sure you want to remove ${name} (${userID}) from this branch?`);

    if (res) {
      fetch(`/manage/user/remove/${userID}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
    })
      .then(response => {
        if (response.ok) {
          // deleted successfully
          const eventContainer = document.getElementById(`member-${userID}`);
          if (eventContainer) {
            eventContainer.remove();
          }
          alert('Member removed successfully!');
        } else if (response.status === 403) {
          alert('You do not have permission to remove this member.');
        } else {
          alert('Failed to remove member. This member may be a manager.');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while removing the member');
      });
    }
    else {
      return;
    }
  }
  </script>
</head>

<body id="app" onload="get_members()">
  <header class="top-pane">
    <nav>
      <a class=nav-link v-for="item in navitems" :key="item.title" :href="item.url">{{ item.title }}</a>
    </nav>
  </header>

  <div class="page-content content">
    <h1> Branch Members - <span id="branch-name"> Loading... </span> </h1>

    <div id="members-container">
      Loading...
    </div>
  </div>
  <br>
  <br>

  <footer>
    &copy; 2024 Your Website. All rights reserved.
    These buttons will be removed, for testing purposes only
    <button type="button" v-on:click="access_level=0"> Visitor </button>
    <button type="button" v-on:click="access_level=1"> User </button>
    <button type="button" v-on:click="access_level=2"> Manager </button>
  </footer>
</body>

</html>